name: Daily issue reminders
on:
  schedule:
    - cron: '30 16 * * *' # every day at 16:30 UTC 
  workflow_dispatch:
jobs:
  remind-due-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Find issues with due:* labels and remind assignees (with escalation)
        run: |
          # Get all open issues that have any label starting with "due:"
          issues=$(gh issue list --state open --json number,title,labels,assignees --jq '.[]')
          
          # Check if we have any issues
          if [ -z "$issues" ] || [ "$issues" = "null" ]; then
            echo "No open issues found"
            exit 0
          fi
          
          echo "$issues" | jq -c '.' | while read -r issue; do
            number=$(echo "$issue" | jq -r '.number')
            assignees=$(echo "$issue" | jq -r '.assignees[].login' | tr '\n' ' ')
            labels=$(echo "$issue" | jq -r '.labels[].name' | tr '\n' ' ')
            
            # Find a label like due:YYYY-MM-DD 
            due_label=$(echo "$labels" | tr ' ' '\n' | grep '^due:[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}$' | head -n1)
            
            if [ -n "$due_label" ]; then
              due_date=${due_label#due:}
              
              # Convert dates to epoch seconds for comparison
              due_epoch=$(date -d "$due_date" +%s 2>/dev/null)
              today_epoch=$(date -d "today" +%s 2>/dev/null)
              
              # Check if date conversion was successful
              if [ -z "$due_epoch" ] || [ -z "$today_epoch" ]; then
                echo "Error: Invalid date format in label '$due_label' for issue #$number"
                continue
              fi
              
              days_overdue=$(( (today_epoch - due_epoch) / 86400 ))
              days_until_due=$(( (due_epoch - today_epoch) / 86400 ))
              
              # Remind if due date is today or earlier (overdue)
              if [ "$due_epoch" -le "$today_epoch" ]; then
                if [ -n "$assignees" ]; then
                  # Build a space-separated @mentions string for all assignees
                  mentions=""
                  for a in $assignees; do
                    mentions="$mentions@$a "
                  done
                  mentions=$(echo "$mentions" | sed 's/ $//')  # Remove trailing space
                  
                  if [ "$days_overdue" -eq 0 ]; then
                    msg=":alarm_clock: Heads up, this issue is due today ($due_date)! $mentions"
                  elif [ "$days_overdue" -le 2 ]; then
                    msg=":warning: This issue is overdue by $days_overdue day(s) ($due_date)! Please take action soon, $mentions"
                  elif [ "$days_overdue" -le 6 ]; then
                    msg=":loudspeaker: Attention! This issue is now $days_overdue days overdue ($due_date). $mentions, please address this as soon as possible."
                  else
                    msg=":bangbang: This issue is $days_overdue days overdue ($due_date)! $mentions, urgent attention required."
                  fi
                  
                  echo "Reminding $assignees about issue #$number due $due_date (overdue by $days_overdue days)"
                  gh issue comment "$number" --body "$msg"
                else
                  echo "Issue #$number is due $due_date but has no assignee"
                fi
              # Also remind if due within next 3 days
              elif [ "$days_until_due" -le 3 ]; then
                if [ -n "$assignees" ]; then
                  mentions=""
                  for a in $assignees; do
                    mentions="$mentions@$a "
                  done
                  mentions=$(echo "$mentions" | sed 's/ $//')
                  
                  msg=":calendar: Reminder: This issue is due in $days_until_due day(s) on $due_date. $mentions"
                  
                  echo "Reminding $assignees about issue #$number due in $days_until_due days ($due_date)"
                  gh issue comment "$number" --body "$msg"
                else
                  echo "Issue #$number is due in $days_until_due days ($due_date) but has no assignee"
                fi
              else
                echo "Issue #$number due $due_date is not yet due (in $days_until_due days)"
              fi
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
